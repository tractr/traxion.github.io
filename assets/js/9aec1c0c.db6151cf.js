"use strict";(self.webpackChunk_trxn_traxion_api=self.webpackChunk_trxn_traxion_api||[]).push([[506],{4093:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>d,contentTitle:()=>l,default:()=>g,frontMatter:()=>s,metadata:()=>u,toc:()=>p});var a=r(7896),i=r(1461),n=(r(2784),r(876)),o=["components"],s={id:"autorizations",title:"Autorizations",sidebar_label:"Autorizations"},l=void 0,u={unversionedId:"graphql-api/autorizations",id:"graphql-api/autorizations",title:"Autorizations",description:"La couche d'autorisation de de traxion est centralis\xe9e dans un module sp\xe9cifique NestjsAuthorizationService. Ce module reprend la m\xeame interface que la couche de business. Elle permet de valider via le parametrage de casl que l'utilisateur courant a bien le droit de manipuler cette entit\xe9e. Chaque methode appel dans son traitement les methodes de la couche de business et rajoute autour cette autorisation.",source:"@site/docs/02-graphql-api/04-autorizations.md",sourceDirName:"02-graphql-api",slug:"/graphql-api/autorizations",permalink:"/graphql-api/autorizations",draft:!1,editUrl:"https://github.com/tractr/traxion/tree/main/apps/docs/docs/02-graphql-api/04-autorizations.md",tags:[],version:"current",sidebarPosition:4,frontMatter:{id:"autorizations",title:"Autorizations",sidebar_label:"Autorizations"},sidebar:"mySidebar",previous:{title:"Business",permalink:"/graphql-api/business"},next:{title:"Architecture de l'api GraphQL",permalink:"/graphql-api/graphql-code-architecture"}},d={},p=[{value:"Configuration du context GraphQL",id:"configuration-du-context-graphql",level:2},{value:"Ajout d&#39;un middleware nestjs permettant la gestion des utilisateurs et des abiliti\xe9s",id:"ajout-dun-middleware-nestjs-permettant-la-gestion-des-utilisateurs-et-des-abiliti\xe9s",level:2}],c={toc:p},m="wrapper";function g(e){var t=e.components,r=(0,i.Z)(e,o);return(0,n.kt)(m,(0,a.Z)({},c,r,{components:t,mdxType:"MDXLayout"}),(0,n.kt)("p",null,"La couche d'autorisation de de traxion est centralis\xe9e dans un module sp\xe9cifique ",(0,n.kt)("inlineCode",{parentName:"p"},"NestjsAuthorizationService"),". Ce module reprend la m\xeame interface que la couche de business. Elle permet de valider via le parametrage de casl que l'utilisateur courant a bien le droit de manipuler cette entit\xe9e. Chaque methode appel dans son traitement les methodes de la couche de business et rajoute autour cette autorisation."),(0,n.kt)("p",null,"Pour r\xe9aliser cette autorisation traxion manipule en son sein seulement une ability (objet cr\xe9\xe9 via casl). Ainsi la configuration de casl peut se faire a l'exterieur de la g\xe9n\xe9ration."),(0,n.kt)("p",null,"La couche de service prend en parametre cette ability et la couche de graphql r\xe9cup\xe8re cette ability dans le context req graphql. Ainsi lors de la configuration de traxion pour permettre l'utilisation de casl il faut rajouter en amont de la chaine (dans un guard global) la cr\xe9ation de cette ability et la mettre dans le context Graphql."),(0,n.kt)("h2",{id:"configuration-du-context-graphql"},"Configuration du context GraphQL"),(0,n.kt)("p",null,"Lors de l'utilisation des generateurs individuels (tous sauf ",(0,n.kt)("inlineCode",{parentName:"p"},"traxion-prisma-generator"),") il faut param\xe9trer le context de votre serveur Graphql. Par exemple:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-ts"},"import { GraphQLModule } from '@nestjs/graphql';\n\n@Module({\n  imports: [\n    GraphQLModule.forRoot<ApolloDriverConfig>({\n      ...\n      context: ({ req, res }) => ({ req, res }),\n    })\n  ]\n})\n...\n")),(0,n.kt)("h2",{id:"ajout-dun-middleware-nestjs-permettant-la-gestion-des-utilisateurs-et-des-abiliti\xe9s"},"Ajout d'un middleware nestjs permettant la gestion des utilisateurs et des abiliti\xe9s"),(0,n.kt)("p",null,"Vous devez par la suite configurer la gestion des utilisateurs et des abilit\xe9s via des guards globals. Pour cela vous pouvez utiliser le token de provider de nestjs ",(0,n.kt)("inlineCode",{parentName:"p"},"APP_GUARD")," pour configurer au niveau de votre application un guard de check d'utilisateur chainer avec un guard de gestion des droits Casl. Traxion vous fournit deux guards existants vous permettant d'utiliser directement les resolvers sans configurations."),(0,n.kt)("p",null,"Note: le guard d'utilisateur doit authentifier l'utilisateur contre votre base de donn\xe9es et doit imp\xe9rativement hydrater votre utilisateurs avec le ",(0,n.kt)("inlineCode",{parentName:"p"},"UserSelectOwnershipIds")," g\xe9n\xe9r\xe9. Ce select va permettre par la suite a casl de v\xe9rifier que votre utilisateur own la data et donc qu'il a bien les droits n\xe9cessaires a sa manipulation."),(0,n.kt)("p",null,"Note: les guards fournit par traxion regarde si le d\xe9corateur ",(0,n.kt)("inlineCode",{parentName:"p"},"@Public()")," de traxion est utilis\xe9 ou non et laisse passer la requ\xeate si jamais ce d\xe9corateur est utilis\xe9 (dans ce cas la c'est les droits configur\xe9 dans publicPermissions qui sont utilis\xe9s). Il est pr\xe9f\xe9rable d'authentifier toutes les routes et de whitelister les routes public que l'inverse."),(0,n.kt)("p",null,"Voici un exemple de configuration des guards fournit par traxion:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-ts"},"@Module({\n  imports: [\n    TrxnAuthenticationModule.register({\n      imports: [UserModule],\n      customSelect,\n      jwtModuleOptions: {\n        secret: process.env.JWT_SECRET || 'secret',\n      },\n    }),\n    CaslModule.register({\n      getRoles,\n      rolePermissions,\n      publicPermissions,\n    }),\n  ],\n  providers: [\n    { provide: APP_GUARD, useClass: JwtGlobalAuthGuard },\n    { provide: APP_GUARD, useClass: PoliciesGuard },\n    { provide: APP_INTERCEPTOR, useClass: CaslExceptionInterceptor },\n  ],\n})\n...\n")),(0,n.kt)("p",null,"Ici le ",(0,n.kt)("inlineCode",{parentName:"p"},"customSelect")," est le user select qui sera utilis\xe9 par le guard ",(0,n.kt)("inlineCode",{parentName:"p"},"JwtGlobalAuthGuard")," et les callback ",(0,n.kt)("inlineCode",{parentName:"p"},"rolePermissions")," et ",(0,n.kt)("inlineCode",{parentName:"p"},"publicPermissions")," sont les fonctions qui permettent de configurer les autorisations casl."),(0,n.kt)("p",null,"Traxion vous met a disposition des modules de helpers permettant d'authentifier et de configurer casl facilement."))}g.isMDXComponent=!0},876:(e,t,r)=>{r.d(t,{Zo:()=>d,kt:()=>g});var a=r(2784);function i(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function n(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,a)}return r}function o(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?n(Object(r),!0).forEach((function(t){i(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):n(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function s(e,t){if(null==e)return{};var r,a,i=function(e,t){if(null==e)return{};var r,a,i={},n=Object.keys(e);for(a=0;a<n.length;a++)r=n[a],t.indexOf(r)>=0||(i[r]=e[r]);return i}(e,t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);for(a=0;a<n.length;a++)r=n[a],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(i[r]=e[r])}return i}var l=a.createContext({}),u=function(e){var t=a.useContext(l),r=t;return e&&(r="function"==typeof e?e(t):o(o({},t),e)),r},d=function(e){var t=u(e.components);return a.createElement(l.Provider,{value:t},e.children)},p="mdxType",c={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var r=e.components,i=e.mdxType,n=e.originalType,l=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),p=u(r),m=i,g=p["".concat(l,".").concat(m)]||p[m]||c[m]||n;return r?a.createElement(g,o(o({ref:t},d),{},{components:r})):a.createElement(g,o({ref:t},d))}));function g(e,t){var r=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var n=r.length,o=new Array(n);o[0]=m;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[p]="string"==typeof e?e:i,o[1]=s;for(var u=2;u<n;u++)o[u]=r[u];return a.createElement.apply(null,o)}return a.createElement.apply(null,r)}m.displayName="MDXCreateElement"}}]);