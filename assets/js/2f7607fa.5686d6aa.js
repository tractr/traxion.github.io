"use strict";(self.webpackChunk_trxn_traxion_api=self.webpackChunk_trxn_traxion_api||[]).push([[743],{3905:(e,t,a)=>{a.d(t,{Zo:()=>d,kt:()=>c});var i=a(7294);function n(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function o(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,i)}return a}function r(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?o(Object(a),!0).forEach((function(t){n(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):o(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function s(e,t){if(null==e)return{};var a,i,n=function(e,t){if(null==e)return{};var a,i,n={},o=Object.keys(e);for(i=0;i<o.length;i++)a=o[i],t.indexOf(a)>=0||(n[a]=e[a]);return n}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(i=0;i<o.length;i++)a=o[i],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(n[a]=e[a])}return n}var l=i.createContext({}),m=function(e){var t=i.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):r(r({},t),e)),a},d=function(e){var t=m(e.components);return i.createElement(l.Provider,{value:t},e.children)},p="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return i.createElement(i.Fragment,{},t)}},h=i.forwardRef((function(e,t){var a=e.components,n=e.mdxType,o=e.originalType,l=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),p=m(a),h=n,c=p["".concat(l,".").concat(h)]||p[h]||u[h]||o;return a?i.createElement(c,r(r({ref:t},d),{},{components:a})):i.createElement(c,r({ref:t},d))}));function c(e,t){var a=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var o=a.length,r=new Array(o);r[0]=h;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[p]="string"==typeof e?e:n,r[1]=s;for(var m=2;m<o;m++)r[m]=a[m];return i.createElement.apply(null,r)}return i.createElement.apply(null,a)}h.displayName="MDXCreateElement"},9143:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>d,contentTitle:()=>l,default:()=>c,frontMatter:()=>s,metadata:()=>m,toc:()=>p});var i=a(7462),n=a(3366),o=(a(7294),a(3905)),r=["components"],s={id:"database-migration-with-prisma",title:"Database migration with Prisma",sidebar_label:"Database migration"},l=void 0,m={unversionedId:"how-to/database/database-migration-with-prisma",id:"how-to/database/database-migration-with-prisma",title:"Database migration with Prisma",description:"What is Prisma ?",source:"@site/docs/how-to/database/database-migration-with-prisma.md",sourceDirName:"how-to/database",slug:"/how-to/database/database-migration-with-prisma",permalink:"/docs/how-to/database/database-migration-with-prisma",draft:!1,editUrl:"https://github.com/tractr/traxion/tree/main/apps/docs/docs/how-to/database/database-migration-with-prisma.md",tags:[],version:"current",frontMatter:{id:"database-migration-with-prisma",title:"Database migration with Prisma",sidebar_label:"Database migration"},sidebar:"documentation",previous:{title:"Configuration",permalink:"/docs/how-to/database/configuration"},next:{title:"File Storage on AWS S3",permalink:"/docs/how-to/file-storage/file-storage-on-aws-s3"}},d={},p=[{value:"What is Prisma ?",id:"what-is-prisma-",level:2},{value:"When to use Prisma migrations",id:"when-to-use-prisma-migrations",level:2},{value:"Migrations state",id:"migrations-state",level:2},{value:"Environments",id:"environments",level:2},{value:"Migrations during development",id:"migrations-during-development",level:2},{value:"Initialize migration history",id:"initialize-migration-history",level:3},{value:"Resetting a development database",id:"resetting-a-development-database",level:3},{value:"Adding new migrations when updating the Prisma schema",id:"adding-new-migrations-when-updating-the-prisma-schema",level:3},{value:"Migrations and collaboration",id:"migrations-and-collaboration",level:3},{value:"Migrations in production",id:"migrations-in-production",level:2}],u={toc:p},h="wrapper";function c(e){var t=e.components,a=(0,n.Z)(e,r);return(0,o.kt)(h,(0,i.Z)({},u,a,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h2",{id:"what-is-prisma-"},"What is Prisma ?"),(0,o.kt)("p",null,"Prisma is a TypeScript ORM that relies on code generation to create a strongly typed database client that matches your database schema."),(0,o.kt)("p",null,"In order to generate the database client, Prisma uses a schema describing your database models and their relationships."),(0,o.kt)("p",null,"Prisma also comes with a migration tool called ",(0,o.kt)("inlineCode",{parentName:"p"},"prisma migrate")," which is capable of generating database migration scripts, allowing you to move from one version of your database schema, to another."),(0,o.kt)("p",null,"As stated in the ",(0,o.kt)("inlineCode",{parentName:"p"},"prisma migrate")," ",(0,o.kt)("a",{parentName:"p",href:"https://www.prisma.io/docs/concepts/components/prisma-migrate"},"documentation"),":"),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"Prisma Migrate is an ",(0,o.kt)("strong",{parentName:"p"},"imperative database schema migration tool")," that enables you to:"),(0,o.kt)("ul",{parentName:"blockquote"},(0,o.kt)("li",{parentName:"ul"},"Keep your database schema in sync with your ",(0,o.kt)("a",{parentName:"li",href:"https://www.prisma.io/docs/concepts/components/prisma-schema"},"Prisma schema")," as it evolves ",(0,o.kt)("em",{parentName:"li"},"and")),(0,o.kt)("li",{parentName:"ul"},"Maintain existing data in your database"))),(0,o.kt)("admonition",{type:"caution"},(0,o.kt)("p",{parentName:"admonition"},"This document is intended to provide an overview of the workflow for using migrations from development to production. However, you should also consult the ",(0,o.kt)("a",{parentName:"p",href:"https://www.prisma.io/docs"},"Prisma documentation")," as this document is not exhaustive!")),(0,o.kt)("h2",{id:"when-to-use-prisma-migrations"},"When to use Prisma migrations"),(0,o.kt)("p",null,"Migrations are a great tool, but you don't need them in the early stages of your project. Prisma also has a command called ",(0,o.kt)("inlineCode",{parentName:"p"},"prisma db push")," which, while serving a similar purpose (updating the database schema), is different from ",(0,o.kt)("inlineCode",{parentName:"p"},"prisma migrate"),"."),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"prisma db push")," command pushes a Prisma schema onto the target database. This is useful for prototyping, but it doesn't guarantee the security of your data and doesn't keep a history of schema changes like migration does."),(0,o.kt)("p",null,"So if your application contains data in a production environment that should not be lost when the schema is updated, you should use migrations. Otherwise, you can continue working without migrations."),(0,o.kt)("h2",{id:"migrations-state"},"Migrations state"),(0,o.kt)("p",null,"Prisma Migrate uses the following state elements to track the status of your database schema:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"Prisma schema"),": Your source of truth that defines the structure of the database schema."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"Migrations history"),": SQL files in your ",(0,o.kt)("inlineCode",{parentName:"li"},"prisma/migrations")," folder representing the history of changes made to your database schema."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"Migrations table"),": ",(0,o.kt)("inlineCode",{parentName:"li"},"prisma_migrations")," table in the database that stores the metadata of migrations that have been applied to the database."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"Database schema"),": The state of the database.")),(0,o.kt)("p",null,"Note that the migration history must be tracked by your versioning system!"),(0,o.kt)("h2",{id:"environments"},"Environments"),(0,o.kt)("admonition",{type:"caution"},(0,o.kt)("p",{parentName:"admonition"},"The Prisma migrate tool uses variables from your environment to connect to the database. You should always be careful when performing migrations, as you could mistakenly make unwanted changes to a production environment.")),(0,o.kt)("h2",{id:"migrations-during-development"},"Migrations during development"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"prisma migrate")," has a dedicated command for development environments called ",(0,o.kt)("inlineCode",{parentName:"p"},"prisma migrate dev"),". This command should only be used in development environments to create and apply migrations. It relies on a shadow database to detect schema drift."),(0,o.kt)("p",null,"When running ",(0,o.kt)("inlineCode",{parentName:"p"},"prisma migrate dev"),", the command"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Reruns the existing migration history in the shadow database to detect schema drift (edited or deleted migration file, or manually modified database schema)."),(0,o.kt)("li",{parentName:"ol"},"Applies current migrations to the shadow database (for example, new migrations created by colleagues)."),(0,o.kt)("li",{parentName:"ol"},"Generates a new migration from any changes you made to the Prisma schema before running ",(0,o.kt)("inlineCode",{parentName:"li"},"migrate dev"),"."),(0,o.kt)("li",{parentName:"ol"},"Applies all unapplied migrations to the development database and updates the ",(0,o.kt)("inlineCode",{parentName:"li"},"_prisma_migrations")," table."),(0,o.kt)("li",{parentName:"ol"},"Triggers the generation of artifacts (e.g., the Prisma client).")),(0,o.kt)("h3",{id:"initialize-migration-history"},"Initialize migration history"),(0,o.kt)("p",null,"When the project reaches a stable schema, and it is no longer possible to flush data during schema changes (usually when there is a staging and/or production environment), it is time to start using migrations."),(0,o.kt)("p",null,"To do so, you need to dump your current database (you can delete the docker volume with ",(0,o.kt)("inlineCode",{parentName:"p"},"docker volume rm <the_name_of_the_volume>"),")."),(0,o.kt)("p",null,"Then you can run ",(0,o.kt)("inlineCode",{parentName:"p"},"prisma migrate dev --create-only")," to generate the initial migration script. Once you have verified that everything is correct in the generated script, you can apply the migration with ",(0,o.kt)("inlineCode",{parentName:"p"},"prisma migrate dev")," and add it to your git history."),(0,o.kt)("h3",{id:"resetting-a-development-database"},"Resetting a development database"),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"prisma migrate reset")," command can be useful when working in development. It can be used to completely reset a database by dropping it, running the migration history, and running the startup script if it is available."),(0,o.kt)("h3",{id:"adding-new-migrations-when-updating-the-prisma-schema"},"Adding new migrations when updating the Prisma schema"),(0,o.kt)("p",null,"Now imagine the following scenario: the project already has a migration history, and you are working on a new feature that requires updating the database schema."),(0,o.kt)("p",null,"While prototyping the database schema, you can use ",(0,o.kt)("inlineCode",{parentName:"p"},"prisma db push")," to apply the schema to the database without creating a migration."),(0,o.kt)("p",null,"When you want to commit the schema changes, you must create the associated database migration. To do this, make sure your database is up to date with the existing migrations (you can for example run ",(0,o.kt)("inlineCode",{parentName:"p"},"prisma migrate reset"),")."),(0,o.kt)("p",null,"Now your database is up to date with the migrations, and the schema is ahead of it, with the functionality changes. You can now run ",(0,o.kt)("inlineCode",{parentName:"p"},"prisma migrate dev --create-only"),", which will create a migration from the state of the last migration to the state of your current Prisma scheme."),(0,o.kt)("p",null,"You should always review the generated migrations as there are some cases that cannot be covered automatically. Usually, when you add tables and columns, the generation is correct, but when you modify existing structures, you will have to edit the migration to make sure there is no data loss or corruption."),(0,o.kt)("p",null,"Example: If you rename a column, Prisma will, by default, drop the column and create a new one. More often than not, you'll want to modify the migration to use a ",(0,o.kt)("inlineCode",{parentName:"p"},"RENAME")," clause to avoid data loss."),(0,o.kt)("p",null,"Once the migration suits your needs, you can apply it to your local database with ",(0,o.kt)("inlineCode",{parentName:"p"},"prisma migrate dev")," and validate it with the new Prisma schema."),(0,o.kt)("admonition",{type:"caution"},(0,o.kt)("p",{parentName:"admonition"},"You must test your migration carefully during development! Once your functionality is merged, the migration is usually deployed automatically by the CI!")),(0,o.kt)("h3",{id:"migrations-and-collaboration"},"Migrations and collaboration"),(0,o.kt)("p",null,"Migrations allow multiple developers to introduce changes to the Prisma schema at the same time. When you pull a branch that contains new migrations, simply apply them with ",(0,o.kt)("inlineCode",{parentName:"p"},"prisma migrate dev"),", or reset your database with ",(0,o.kt)("inlineCode",{parentName:"p"},"prisma migrate reset"),". Then you are free to make your own changes and generate the associated migrations."),(0,o.kt)("h2",{id:"migrations-in-production"},"Migrations in production"),(0,o.kt)("p",null,"Migrations are created during the development stage of a feature, but once the feature is deployed in a production environment, they must be applied to the associated database."),(0,o.kt)("p",null,"Prisma provides us with the ",(0,o.kt)("inlineCode",{parentName:"p"},"prisma migrate deploy")," command which:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Compares applied migrations with the migration history and ",(0,o.kt)("strong",{parentName:"p"},"warns")," if any migrations have been changed:"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre"},"WARNING The following migrations have been modified since they were applied:\n20210313140442_favorite_colors\n"))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Apply pending migrations"))),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"migrate deploy")," command:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"Does not")," issue a warning if an already applied migration is ",(0,o.kt)("em",{parentName:"li"},"missing")," in the migration history."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"Does not")," detect drift (the schema of the production database differs from the final state of the migration history - for example, due to a patch)."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"Does not")," reset the database or generate artifacts (like Prisma Client)."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"Does not")," rely on a shadow database.")),(0,o.kt)("p",null,"Usually, migrations should be applied during the CI process before deploying the associated code. However, if this is not the case, or if for some other reason you need to apply them manually, you can run the ",(0,o.kt)("inlineCode",{parentName:"p"},"prisma migrate deploy")," command while connected to the target database."),(0,o.kt)("p",null,"Also, the migration deployment may fail. The ",(0,o.kt)("inlineCode",{parentName:"p"},"migrate")," command has some tools for resolving migration failures, but that topic is outside the scope of this document. You should refer to the official documentation in case of migration failure (",(0,o.kt)("a",{parentName:"p",href:"https://www.prisma.io/docs/guides/database/production-troubleshooting"},"https://www.prisma.io/docs/guides/database/production-troubleshooting"),")."))}c.isMDXComponent=!0}}]);