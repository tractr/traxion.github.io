"use strict";(self.webpackChunk_trxn_traxion_api=self.webpackChunk_trxn_traxion_api||[]).push([[266],{1517:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>p,contentTitle:()=>l,default:()=>m,frontMatter:()=>o,metadata:()=>u,toc:()=>c});var a=r(7896),n=r(1461),s=(r(2784),r(876)),i=["components"],o={id:"graphql-code-architecture",title:"Architecture de l'api GraphQL",sidebar_label:"Architecture de l'api GraphQL"},l=void 0,u={unversionedId:"graphql-api/graphql-code-architecture",id:"graphql-api/graphql-code-architecture",title:"Architecture de l'api GraphQL",description:"Vue d'ensemble",source:"@site/docs/02-graphql-api/code-architecture.md",sourceDirName:"02-graphql-api",slug:"/graphql-api/graphql-code-architecture",permalink:"/graphql-api/graphql-code-architecture",draft:!1,editUrl:"https://github.com/tractr/traxion/tree/main/apps/docs/docs/02-graphql-api/code-architecture.md",tags:[],version:"current",frontMatter:{id:"graphql-code-architecture",title:"Architecture de l'api GraphQL",sidebar_label:"Architecture de l'api GraphQL"},sidebar:"mySidebar",previous:{title:"Autorizations",permalink:"/graphql-api/autorizations"},next:{title:"ROADMAP",permalink:"/ROADMAP"}},p={},c=[{value:"Vue d&#39;ensemble",id:"vue-densemble",level:2},{value:"Api graphql publique",id:"api-graphql-publique",level:3},{value:"Conceptes",id:"conceptes",level:4},{value:"Flow de donn\xe9es \xe0 travers les diff\xe9rentes couches",id:"flow-de-donn\xe9es-\xe0-travers-les-diff\xe9rentes-couches",level:4},{value:"Graph de d\xe9pendances entre les diff\xe9rentes &quot;librairies&quot;",id:"graph-de-d\xe9pendances-entre-les-diff\xe9rentes-librairies",level:4},{value:"Api graphql authentifi\xe9e",id:"api-graphql-authentifi\xe9e",level:3},{value:"Conceptes",id:"conceptes-1",level:4},{value:"Flow de donn\xe9es \xe0 travers les diff\xe9rentes couches",id:"flow-de-donn\xe9es-\xe0-travers-les-diff\xe9rentes-couches-1",level:4},{value:"Graph de d\xe9pendances entre les diff\xe9rentes &quot;librairies&quot;",id:"graph-de-d\xe9pendances-entre-les-diff\xe9rentes-librairies-1",level:4}],d={toc:c},h="wrapper";function m(e){var t=e.components,r=(0,n.Z)(e,i);return(0,s.kt)(h,(0,a.Z)({},d,r,{components:t,mdxType:"MDXLayout"}),(0,s.kt)("h2",{id:"vue-densemble"},"Vue d'ensemble"),(0,s.kt)("h3",{id:"api-graphql-publique"},"Api graphql publique"),(0,s.kt)("h4",{id:"conceptes"},"Conceptes"),(0,s.kt)("p",null,"Le code de l'api graphql publique est organis\xe9 en 3 couches, ayant chacune un r\xf4le bien d\xe9fini:"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("p",{parentName:"li"},(0,s.kt)("strong",{parentName:"p"},"La couche r\xe9seau")," - Cette couche d\xe9finit l'interface de l'api graphql, ainsi que la logique pour r\xe9soudre les requ\xeatse. Elle est compos\xe9e de:"),(0,s.kt)("ul",{parentName:"li"},(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("strong",{parentName:"li"},"DTOs"),": ils d\xe9finissent le sch\xe9ma graphql ainsi que la validation des donn\xe9es re\xe7ues en entr\xe9e de l'api. Plus concr\xe8tement, il s'agit de classes typescript annot\xe9es avec des d\xe9corateurs graphql pour la d\xe9finition du sch\xe9ma et des d\xe9corateurs class-validator pour la validation des donn\xe9es. Le g\xe9n\xe9rateur r\xe9sponsable de la g\xe9n\xe9ration de cette couche est ",(0,s.kt)("a",{parentName:"li",href:"https://github.com/unlight/prisma-nestjs-graphql"},"prisma-nestjs-graphql"),"."),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("strong",{parentName:"li"},"R\xe9solveurs"),": ils d\xe9finissent la logique pour r\xe9soudre les requ\xeates graphql, et d\xe9l\xe8guent le traitement \xe0 la couche m\xe9tier."))),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("p",{parentName:"li"},(0,s.kt)("strong",{parentName:"p"},"La couche m\xe9tier")," - Cette couche d\xe9finit la logique m\xe9tier de l'api, et d\xe9l\xe8gue ensuite la r\xe9cup\xe9ration des donn\xe9es \xe0 la couche suivante. La couche m\xe9tier g\xe9n\xe9r\xe9e est par d\xe9faut plutot vide, et \xe0 plutot vocation \xe0 \xeatre \xe9tendue et enrichie avec du code custom. Elle est g\xe9n\xe9r\xe9e par le g\xe9n\xe9rateur ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/tractr/traxion"},"@trxn/prisma-nestjs-services-generator"),".")),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("p",{parentName:"li"},(0,s.kt)("strong",{parentName:"p"},"La couche de donn\xe9es")," - Cette couche d\xe9finit la logique d'acc\xe8s aux donn\xe9es et consiste principaleremt en un client prisma wrapp\xe9 pour \xeatre consom\xe9 dans un context nestjs. Elle est g\xe9r\xe9e par le m\xeame g\xe9n\xe9rateur que la couche pr\xe9c\xe9dent (",(0,s.kt)("a",{parentName:"p",href:"https://github.com/unlight/prisma-nestjs-graphql"},"prisma-nestjs-graphql"),")"))),(0,s.kt)("h4",{id:"flow-de-donn\xe9es-\xe0-travers-les-diff\xe9rentes-couches"},"Flow de donn\xe9es \xe0 travers les diff\xe9rentes couches"),(0,s.kt)("mermaid",{value:"flowchart LR;\n\n  dto(Couche r\xe9seau)\n  business(Couch m\xe9tier)\n  data(Couche de donn\xe9es)\n  database[(Database)]\n  \n  dto --\x3e business\n  business --\x3e data\n  data --\x3e database\n  database --\x3e data\n  data --\x3e business\n  business --\x3e dto"}),(0,s.kt)("h4",{id:"graph-de-d\xe9pendances-entre-les-diff\xe9rentes-librairies"},'Graph de d\xe9pendances entre les diff\xe9rentes "librairies"'),(0,s.kt)("mermaid",{value:"flowchart LR;\n\n  dto(Nestjs GraphQL DTOs)\n  resolvers(Nestjs GraphQL Resolvers)\n  services(Nestjs Services)\n  \n  resolvers --\x3e dto\n  resolvers --\x3e services"}),(0,s.kt)("h3",{id:"api-graphql-authentifi\xe9e"},"Api graphql authentifi\xe9e"),(0,s.kt)("h4",{id:"conceptes-1"},"Conceptes"),(0,s.kt)("p",null,"L'api GraphQL authentifi\xe9e est compos\xe9e des m\xeames couches que l'api graphql publique, auxquelles est ajout\xe9e une couche responsable de l'authentification/autorisation. La partie authentification est impl\xe9ment\xe9e avec ",(0,s.kt)("a",{parentName:"p",href:"http://www.passportjs.org/"},"passport"),", et la partie autorisation avec ",(0,s.kt)("a",{parentName:"p",href:"https://casl.js.org/v5/en/"},"casl"),"."),(0,s.kt)("p",null,"Pour g\xe9n\xe9rer la couchea d'autorisation de l'api, 3 g\xe9n\xe9rateurs entrent en jeu:"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("p",{parentName:"li"},(0,s.kt)("a",{parentName:"p",href:"https://github.com/tractr/traxion/tree/main/libs/hapify/prisma/casl-generator"},"@trxn/prisma-casl-generator")," - Ce g\xe9n\xe9rateur g\xe9n\xe8re toute une liste de droits et permissions pour chaque entit\xe9e de la mod\xe9lisation, ainsi qu'une strat\xe9gie d'authorisation par d\xe9faut. Ces permission peuvent ensuite \xeatre compos\xe9es pour d\xe9finir une gestion de roles et autorisation plus complexe. Le g\xe9n\xe9rateur g\xe9nere aussi une gestion de role par d\xe9faut qui devrait couvrir les cas les plus simples.")),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("p",{parentName:"li"},(0,s.kt)("a",{parentName:"p",href:"https://github.com/tractr/traxion/tree/main/libs/hapify/prisma/nestjs-authorized-services-generator"},"@trxn/prisma-nestjs-authorized-services-generator")," - Ce g\xe9n\xe9rateur g\xe9n\xe8re des services qui vont appliquer la gestion d'authorisations d\xe9finie par le g\xe9n\xe9rateur pr\xe9c\xe9dent avant de d\xe9l\xe9guer le traitement des donn\xe9es \xe0 la couche m\xe9tier.")),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("p",{parentName:"li"},(0,s.kt)("a",{parentName:"p",href:"https://github.com/tractr/traxion/tree/main/libs/hapify/prisma/nestjs-authorized-graphql-resolvers-generator"},"@trxn/prisma-nestjs-authorized-graphql-resolvers-generator")," - Ce g\xe9n\xe9rateur vient enrichir les r\xe9solveurs g\xe9n\xe9r\xe9s pour l'api publique afin d'y ajouter les gardes et la logique d'authorisation."))),(0,s.kt)("h4",{id:"flow-de-donn\xe9es-\xe0-travers-les-diff\xe9rentes-couches-1"},"Flow de donn\xe9es \xe0 travers les diff\xe9rentes couches"),(0,s.kt)("mermaid",{value:"flowchart LR;\n\n  dto(Couche r\xe9seau)\n  auth(Couche d'authentification/autorisation)\n  business(Couch m\xe9tier)\n  data(Couche de donn\xe9es)\n  database[(Database)]\n  \n  dto --\x3e auth\n  auth --\x3e business\n  business --\x3e data\n  data --\x3e database\n  database --\x3e data\n  data --\x3e business\n  business --\x3e auth\n  auth --\x3e dto"}),(0,s.kt)("h4",{id:"graph-de-d\xe9pendances-entre-les-diff\xe9rentes-librairies-1"},'Graph de d\xe9pendances entre les diff\xe9rentes "librairies"'),(0,s.kt)("mermaid",{value:"flowchart LR;\n\n  dto(Nestjs GraphQL DTOs)\n  resolvers(Nestjs authorized GraphQL Resolvers)\n  authorizedServices(Nestjs authorized Services)\n  services(Nestjs Services)\n  casl(Casle)\n  \n  resolvers --\x3e dto\n  resolvers --\x3e authorizedServices\n  resolvers --\x3e casl\n  authorizedServices --\x3e services\n  authorizedServices --\x3e casl"}),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},".\n\u251c\u2500\u2500 node_modules\n\u251c\u2500\u2500 package.json\n\u251c\u2500\u2500 tsconfig.app.json\n\u251c\u2500\u2500 tsconfig.json\n|\u2500\u2500 tsconfig.spec.json\n\u251c\u2500\u2500 README.md\n\u251c\u2500\u2500 prisma\n\u2502   \u251c\u2500\u2500 schema.prisma\n\u2502   \u2514\u2500\u2500 seed.ts\n\u251c\u2500\u2500 src\n    \u251c\u2500\u2500 app\n    \u2502   \u251c\u2500\u2500 app.module.ts\n    \u2502   \u251c\u2500\u2500 config\n    \u2502   \u2502   \u251c\u2500\u2500 authorization.config.ts\n    \u2502   \u2502   \u2514\u2500\u2500 index.ts\n    \u2502   \u251c\u2500\u2500 modules\n    \u2502   \u2502   \u251c\u2500\u2500 authentication.module.ts\n    \u2502   \u2502   \u251c\u2500\u2500 authorized-services.module.ts\n    \u2502   \u2502   \u251c\u2500\u2500 database.module.ts\n    \u2502   \u2502   \u251c\u2500\u2500 graphql.module.ts\n    \u2502   \u2502   \u251c\u2500\u2500 index.ts\n    \u2502   \u2502   \u251c\u2500\u2500 services.module.ts\n    \u2502   \u2502   \u2514\u2500\u2500 user.module.ts\n    \u2502   \u2514\u2500\u2500 resolvers\n    \u2502       \u2514\u2500\u2500 custom.resolver.ts\n    \u251c\u2500\u2500 casl\n    \u2502   \u2514\u2500\u2500 ...\n    \u251c\u2500\u2500 nestjs-authorized-resolvers\n    \u2502   \u2514\u2500\u2500 ...\n    \u251c\u2500\u2500 nestjs-authorized-services\n    \u2502   \u2514\u2500\u2500 ...\n    \u251c\u2500\u2500 nestjs-graphql-dtos\n    \u2502   \u2514\u2500\u2500 ...\n    \u251c\u2500\u2500 nestjs-resolvers\n    \u2502   \u2514\u2500\u2500 ...\n    \u251c\u2500\u2500 nestjs-services\n    \u2502   \u2514\u2500\u2500 ...\n    \u2514\u2500\u2500 main.ts\n")))}m.isMDXComponent=!0},876:(e,t,r)=>{r.d(t,{Zo:()=>p,kt:()=>m});var a=r(2784);function n(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function s(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,a)}return r}function i(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?s(Object(r),!0).forEach((function(t){n(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):s(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function o(e,t){if(null==e)return{};var r,a,n=function(e,t){if(null==e)return{};var r,a,n={},s=Object.keys(e);for(a=0;a<s.length;a++)r=s[a],t.indexOf(r)>=0||(n[r]=e[r]);return n}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(a=0;a<s.length;a++)r=s[a],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(n[r]=e[r])}return n}var l=a.createContext({}),u=function(e){var t=a.useContext(l),r=t;return e&&(r="function"==typeof e?e(t):i(i({},t),e)),r},p=function(e){var t=u(e.components);return a.createElement(l.Provider,{value:t},e.children)},c="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},h=a.forwardRef((function(e,t){var r=e.components,n=e.mdxType,s=e.originalType,l=e.parentName,p=o(e,["components","mdxType","originalType","parentName"]),c=u(r),h=n,m=c["".concat(l,".").concat(h)]||c[h]||d[h]||s;return r?a.createElement(m,i(i({ref:t},p),{},{components:r})):a.createElement(m,i({ref:t},p))}));function m(e,t){var r=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var s=r.length,i=new Array(s);i[0]=h;var o={};for(var l in t)hasOwnProperty.call(t,l)&&(o[l]=t[l]);o.originalType=e,o[c]="string"==typeof e?e:n,i[1]=o;for(var u=2;u<s;u++)i[u]=r[u];return a.createElement.apply(null,i)}return a.createElement.apply(null,r)}h.displayName="MDXCreateElement"}}]);